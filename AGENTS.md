# SoupReader 协作规范（AGENTS）

> 适用范围：`/home/server/soupreader` 全项目。

## 1) 总原则（强约束）

- 所有回复、说明、代码评审意见默认使用中文。
- **书源处理规则语义与功能行为以同级项目 `legado` 为第一标准**。

### 1.1 legado 复刻前置规则（强制）

- 所有功能开发在动手前，必须先确认 legado 中对应功能的实现与行为。
- 所有功能开发在确认 legado 对应实现时，必须将相关 legado 文件完整读取后再下结论。
- 复刻时必须以 legado 的交互语义、状态流转和边界处理为基准，避免主观改写。
- 若暂时无法确认 legado 对应实现，需先暂停开发并与需求方确认后再继续。

### 1.2 UI 规范（强制）

- 使用 `Shadcn + Cupertino`。
- 全项目新增/改造 UI 必须使用 `Shadcn + Cupertino` 组合。
- 禁止引入或混用其它 UI 组件体系（如纯 Material 风格组件）作为主实现。
- 若遇到 `Shadcn/Cupertino` 暂无等价能力的特殊场景，必须在任务说明与 `docs/DEV_PROGRESS.md` 中写明原因、范围和替代方案。
- 评审若发现不符合本规范，视为阻塞项，需整改后再提交。
- 文档：`https://mariuti.com/flutter-shadcn-ui/llms.txt`

---

## 2) 功能落地要求（按 legado 目标推进）

### 2.1 网络与会话

- 保持持久化 CookieJar（应用重启后可复用会话）。
- 维持请求/响应编码处理（含 GBK 等站点常见编码回退）。
- 请求层异常必须可观测（状态码、关键响应头、错误摘要）。

### 2.2 五段链路必须可调试

- 搜索（search）
- 发现（explore）
- 详情（bookInfo）
- 目录（toc）
- 正文（content）

任何影响上述链路的改动，必须同步维护调试输出与回归验证。

---

## 3) 测试与验收（提交推送前检查）

- 在提交推送前，仅需执行：
  - `flutter analyze`

---

## 4) 开发进度更新（必须）

- 每次完成一个可交付点（修复/新增/调整）后，**必须**同步更新：
  - `docs/DEV_PROGRESS.md`
- 更新内容至少包含：
  - 做了什么（变更点）
  - 为什么（问题/需求）
  - 如何验证（测试命令或手工路径）
- 若改动可能影响旧书源兼容性，必须在进度记录中写清“兼容影响”。

---

## 5) 任务执行与沟通流程（必须）

- 接到需求后，先拆分为可执行的 Todo 列表。
- 从第 1 项开始连续执行，直到所有 Todo 完成。
- 执行过程中，不要在每完成一项后询问“是否继续”。
- 仅在以下场景可以暂停并询问：
  1. 缺少必要信息，导致无法继续；
  2. 存在明显风险或破坏性操作（如删除、覆盖、付费、生产环境操作等）。
- 全部完成后，回复必须包含：
  - 完成情况汇总
  - 变更文件列表
  - 如何验证
