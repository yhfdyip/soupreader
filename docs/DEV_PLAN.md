# SoupReader 开发计划（简明版）

> 目标：先把“导入书源 → 搜索/发现 → 加入书架 → 阅读 → 正文分页/净化 → 进度保存”做成 **稳定可用**。
>
> 规则语义基线：同级项目 `legado/`  
> 可用性落地目标：同级项目 `dbss/asm/source_analyzer` 的链路能力（以“能跑通”为准）

> 同类产品功能对标参考：`docs/HAPPY_PARITY_MATRIX.md`（仅作功能/交互对标，不改变 legado 协议语义）

## 维护说明

- 本文件：写“要做什么 + 验收标准”（相对稳定）。
- 进度日志：每次开发完成后更新 `docs/DEV_PROGRESS.md`（按日期记录，持续追加）。
- **不要**在这里写过长的技术细节；技术推导放到对应 PR/Issue 或单独文档。

## 不变原则（硬约束）

1) **兼容优先**：书源字段名/规则语义/URL 选项，尽量与 `legado` 一致。  
2) **可用性优先**：同一书源下，能搜到/能进书/能翻页/能读完一章，比 UI 花活更重要。  
3) **可诊断优先**：失败时必须能知道“卡在哪一步 + 大概原因”，避免只有“失败”。  
4) **最小改动**：除非必要，不做大重构；兼容逻辑集中在解析/引擎层，不散落 UI。  

---

## 当前执行 Todo（滚动看板）

> 说明：后续开发按本看板顺序推进（Done / Doing / Todo），每完成一项同步更新 `docs/DEV_PROGRESS.md`。

### Done（已完成）

- [x] P0-1：导入链路可诊断（重定向/CORS/冲突策略）
- [x] P0-2：搜索/发现失败隔离、结果去重与稳定排序
- [x] P0-3：加书兜底回退、目录去重、半成功回滚
- [x] P0-4：滚动/翻页进度保存恢复与模式切换一致性
- [x] P0-5：结构化调试摘要、失败分类标签、可用性检测接入
- [x] P1-2：书源编辑器一键测试链路补齐（搜索 + 正文）
- [x] P2：阅读设置面板细化（文案统一/高频前置/不可达分支清理）
- [x] P2：阅读页 UI/UX 重构（顶栏/底栏/右侧悬浮快捷栏）
- [x] P0：书源能力 legado 对标矩阵与分级 Todo（`docs/LEGADO_SOURCE_PARITY_MATRIX.md`）
- [x] P0：登录态缓存接入（header/info 持久化 + 请求自动并入）

### Doing（进行中）

- [ ] P2：缓存可视化与清理（体积展示/清理策略）

### Todo（待办）

- [ ] P0：登录脚本链路对齐（`loginUrl/loginCheckJs` 执行与校验）
- [ ] P0：段评与正文扩展语义落地（`ruleReview/imageDecode/payAction/sourceRegex`）
- [ ] P0：导入导出保真（未知字段不丢失，优先 rawJson）
- [ ] P0：书源界面流程对齐 legado（导入/调试/编辑使用逻辑）
- [ ] P2：目录/书签/跳章体验收敛
- [ ] P3：备份导入导出（优先书源+设置）

---

## P0（必须）：主流程稳定可用

### P0-1 书源导入可靠

- [x] 文件导入：支持 `.json/.txt`，错误提示明确（空内容/非对象/非数组等）
- [x] 剪贴板导入：支持对象/数组/字符串嵌套 JSON
- [x] 网络导入：跟随重定向；Web 端遇到 CORS 给出可执行替代方案（例如提示用文件/剪贴板）
- [x] 冲突策略：重复 `bookSourceUrl` 的覆盖/跳过/取消逻辑一致，且提示清楚

**验收**
- 导入 1 个合法书源：列表可见；导入 1 个错误文件：提示原因；导入重复：结果符合选择策略。

### P0-2 搜索 / 发现稳定出结果

- [x] 对每个书源的失败隔离：单个源失败不影响其他源继续跑
- [x] 结果字段底线：`name/author/bookUrl` 至少稳定可用（cover/intro 可缺省但不崩）
- [x] 请求超时/状态码/解析失败：错误信息可读，能用于定位

**验收**
- 启用多个书源搜索同一关键词：至少能看到部分结果；失败源能看到失败原因。

### P0-3 加入书架稳定

- [x] 详情解析失败有回退（例如 `tocUrl` 为空时用 `bookUrl` 兜底）
- [x] 目录为空/章节为空：给出明确提示（更像“规则不匹配”，而不是静默失败）
- [x] 章节写入 Hive：章节数量与目录一致（允许少量过滤，但不可丢到 0）

**验收**
- 从搜索/发现点“加入书架”：书架出现该书；点开能进入阅读页并看到章节列表/正文。

### P0-4 阅读正文可连续翻页 + 进度保存可靠

- [x] 正文分页（`nextContentUrl`）：能正确结束，不无限翻页
- [x] 下一章阻断：命中“下一章链接”时停止正文翻页（避免把下一章当分页）
- [x] 替换净化（ReplaceRule）：可用且不会拖死 UI（正则超时要兜底）
- [x] 进度保存：章节 index + 滚动偏移（或分页位置）可靠

**验收**
- 连续阅读一章（含分页站点）：能自动拼接；退出再进：进度恢复到合理位置。

### P0-5 调试/导出能帮你定位问题

- [x] 调试页输出包含：请求 URL、关键 header（脱敏）、状态码、耗时、响应摘要、解析摘要
- [x] 导出调试包：用户提供后能复现定位（尽量“一眼看出问题在哪”）

**验收**
- 对一个失败书源：能导出调试包；包内信息足以判断是“请求失败/编码问题/规则问题/分页问题”。

---

## P1：书源工具顺手（可维护/可自助）

### P1-1 书源管理更好用

- [ ] 分组/筛选/启用禁用：交互顺手
- [ ] 批量操作：一键禁用失效源 / 删除失效源（至少保留确认弹窗）
- [ ] 可用性检测：结果可筛选；失败项可一键进入编辑/调试

### P1-2 书源编辑器“先做能用，再做好用”

- [x] 优先实现：**JSON 直接编辑**（保真，不丢未知字段）
- [x] 基础校验：缺关键字段时给出提示（bookSourceUrl/name、searchUrl、ruleSearch…）
- [x] 一键测试：至少覆盖“搜索”和“正文”两个入口（先解决 80% 问题）

---

## P2：阅读体验与缓存（稳定后再追求体验）

- [x] 阅读设置 UI：字号/行距/边距/主题/亮度/翻页方式等高频项补齐
- [x] 阅读主界面对标：补齐“换源/净化/刷新”等高频入口的信息架构与操作流
- [ ] 界面设置精调：内容/页眉/页脚/安全区四边独立参数与实时预览
- [x] 阅读态换源闭环：候选源筛选、换源失败回退、错误可诊断
- [ ] 缓存可视化与清理：显示缓存体积；清理不误删本地书
- [ ] 目录/书签/跳章：基础体验对齐常见阅读器

---

## P3：备份与同步（最后做）

- [ ] 本地备份导出/导入：优先“书源 + 设置”，可选是否含书架/缓存
- [ ] 同步（WebDAV/云）：在 P0/P1 稳定后再启动

---

## 开发门禁（建议执行）

### 解析引擎相关改动（必跑）

- `flutter test test/rule_parser_engine_css_nth_compat_test.dart`
- `flutter test test/rule_parser_engine_rule_split_compat_test.dart`
- `flutter test test/rule_parser_engine_variable_rule_compat_test.dart`
- `flutter test test/rule_parser_engine_url_option_compat_test.dart`
- `flutter test test/rule_parser_engine_next_url_compat_test.dart`

### 导入导出相关改动（建议跑）

- `flutter test test/source_import_export_service_test.dart`
- `flutter test test/source_import_export_conflict_logic_test.dart`
- `flutter test test/legado_json_test.dart`
