# SoupReader iOS Build Workflow
# 每次推送代码自动编译生成未签名的IPA

name: Build iOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      # 显示 Flutter 版本信息
      - name: Flutter version
        run: flutter --version

      # 获取依赖
      - name: Get dependencies
        run: flutter pub get

      # 分析代码（仅警告不阻止构建）
      - name: Analyze code
        run: flutter analyze --no-fatal-infos --no-fatal-warnings
        continue-on-error: true

      # 构建 iOS（无签名）
      # 添加 --no-codesign 还是不够，需要传递参数给 xcodebuild 明确禁止签名
      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign -- CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY="" PROVISIONING_PROFILE=""
          
      # 创建未签名的 IPA (Release需要IPA文件)
      - name: Create unsigned IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r ../ipa/SoupReader-unsigned.ipa Payload
          rm -rf Payload

      # 发布到 GitHub Releases
      - name: Deploy to Releases
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: nightly
          name: Nightly Build
          body: "最新构建: ${{ github.sha }}\n构建时间: ${{ github.event.head_commit.timestamp }}"
          artifacts: "build/ios/ipa/SoupReader-unsigned.ipa"
          token: ${{ secrets.GITHUB_TOKEN }}
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true

      # 上传 App Bundle 作为 Artifact (开发调试用)
      - name: Upload .app artifact
        uses: actions/upload-artifact@v4
        with:
          name: Runner.app
          path: build/ios/iphoneos/Runner.app
          retention-days: 3

      # 上传 dSYM 文件（用于崩溃分析）
      - name: Upload dSYM
        uses: actions/upload-artifact@v4
        with:
          name: SoupReader-iOS-dSYM
          path: build/ios/iphoneos/Runner.app.dSYM
          retention-days: 30
          if-no-files-found: ignore
