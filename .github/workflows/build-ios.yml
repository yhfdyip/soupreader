# SoupReader iOS Build Workflow
# æ¯æ¬¡æ¨é€ä»£ç è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆæœªç­¾åçš„IPA

name: Build iOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-14  # M1 èŠ¯ç‰‡ï¼Œæ¯” macos-latest æ›´å¿«
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Flutter ç¼“å­˜ï¼ˆåŒ…å« SDK å’Œ pub ç¼“å­˜ï¼‰
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      # CocoaPods ç¼“å­˜
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: pods-

      # è·å–ä¾èµ–ï¼ˆå¹¶è¡Œå®‰è£… podsï¼‰
      - name: Get dependencies
        run: |
          flutter pub get
          cd ios && pod install --repo-update || pod install

      # ç¦ç”¨ä»£ç ç­¾å - å¿…é¡»å½»åº•ç¦ç”¨æ‰€æœ‰ç­¾åç›¸å…³è®¾ç½®
      - name: Disable Codesign
        run: |
          cd ios
          # ä¿®æ”¹ project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGNING_REQUIRED=YES"/"CODE_SIGNING_REQUIRED=NO"/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGNING_ALLOWED=YES"/"CODE_SIGNING_ALLOWED=NO"/g' Runner.xcodeproj/project.pbxproj
          # æ¸…é™¤å¼€å‘å›¢é˜Ÿ
          sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' Runner.xcodeproj/project.pbxproj
          # æ·»åŠ åˆ° xcconfig
          echo 'CODE_SIGNING_ALLOWED=NO' >> Flutter/Release.xcconfig
          echo 'CODE_SIGNING_REQUIRED=NO' >> Flutter/Release.xcconfig
          echo 'CODE_SIGN_IDENTITY=""' >> Flutter/Release.xcconfig
          echo 'PROVISIONING_PROFILE_SPECIFIER=""' >> Flutter/Release.xcconfig
          # æ·»åŠ åˆ° Debug.xcconfig ä»¥é˜²ä¸‡ä¸€
          echo 'CODE_SIGNING_ALLOWED=NO' >> Flutter/Debug.xcconfig
          echo 'CODE_SIGNING_REQUIRED=NO' >> Flutter/Debug.xcconfig

      # æ„å»º iOS
      - name: Build iOS
        run: flutter build ios --release --no-codesign
          
      # åˆ›å»º IPA
      - name: Create IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -rq ../ipa/SoupReader-unsigned.ipa Payload

      # å‘å¸ƒåˆ° Releases
      - name: Deploy
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: nightly
          commit: ${{ github.sha }}
          name: Nightly Build
          body: |
            ğŸ“¦ Commit: ${{ github.sha }}
            â° ${{ github.event.head_commit.timestamp }}
          artifacts: "build/ios/ipa/SoupReader-unsigned.ipa"
          token: ${{ secrets.GITHUB_TOKEN }}
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true
